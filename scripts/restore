#!/bin/bash

#=================================================
# IMPORT GENERIC HELPERS
#=================================================

#Keep this path for calling _common.sh inside the execution's context of backup and restore scripts
source ../settings/scripts/_common.sh
source /usr/share/yunohost/helpers

#=================================================
# RESTORE THE APP MAIN DIR
#=================================================
ynh_script_progression "Restoring the app main directory..."

ynh_restore "$install_dir"

#REMOVEME? Assuming the install dir is setup using ynh_setup_source, the proper chmod/chowns are now already applied and it shouldn't be necessary to tweak perms | chmod 750 "$install_dir"
#REMOVEME? Assuming the install dir is setup using ynh_setup_source, the proper chmod/chowns are now already applied and it shouldn't be necessary to tweak perms | chmod -R o-rwx "$install_dir"
#REMOVEME? Assuming the install dir is setup using ynh_setup_source, the proper chmod/chowns are now already applied and it shouldn't be necessary to tweak perms | chown -R "$app:www-data" "$install_dir"
chmod 644 "$install_dir/htdocs/conf/conf.php"

#=================================================
# RESTORE THE MYSQL DATABASE
#=================================================
ynh_script_progression "Restoring the MySQL database..."

ynh_mysql_db_shell < ./db.sql

#=================================================
# RESTORE SYSTEM CONFIGURATIONS
#=================================================
ynh_script_progression "Restoring system configurations related to $app..."

# Restore the file first, so it can have a backup if different
ynh_restore "/etc/php/$php_version/fpm/pool.d/$app.conf"

# Recreate a dedicated php-fpm config
ynh_config_add_phpfpm

ynh_restore "/etc/nginx/conf.d/$domain.d/$app.conf"

ynh_restore "/etc/logrotate.d/$app"

#=================================================
# RELOAD NGINX AND PHP-FPM
#=================================================
ynh_script_progression "Reloading NGINX web server and PHP-FPM..."

ynh_systemctl --service="php$php_version-fpm" --action=reload
ynh_systemctl --service=nginx --action=reload

#=================================================
# RESTORE syncyunohost.sh
#=================================================
ynh_print_info "restoring syncyunohost.sh script to /usr/local/bin/..."

ynh_restore "/usr/local/bin/syncyunohost.sh"
chmod 550 /usr/local/bin/syncyunohost.sh

ynh_print_info "restoring sudoers.d file"
ynh_restore "/etc/sudoers.d/dolibarr_syncyunohost"
#REMOVEME? Assuming the file is setup using ynh_config_add, the proper chmod/chowns are now already applied and it shouldn't be necessary to tweak perms | chmod 440 /etc/sudoers.d/dolibarr_syncyunohost
visudo -c

#=================================================
# RESTORE YUNOHOST GROUP USERS
#=================================================

GROUP_BACKUP_FILE="$install_dir/group_members.json"

if [ -f "$GROUP_BACKUP_FILE" ]; then
    ynh_script_progression "Restoring YunoHost group users..."

    if [ -z "$syncyunohost_main_group" ]; then
        ynh_print_warn "No main group set in syncyunohost_main_group, skipping group restoration."
    else
        ynh_print_info "Restoring users to YunoHost group: $syncyunohost_main_group"

        # Remove current members
        CURRENT_MEMBERS=$(yunohost user group list --output-as json | jq -r ".groups[\"$syncyunohost_main_group\"].members | join(\" \")")

        if [ ! -z "$CURRENT_MEMBERS" ]; then
            yunohost user group remove "$syncyunohost_main_group" $CURRENT_MEMBERS
        fi

        # Read users from backup
        BACKED_UP_MEMBERS=$(jq -r '.[]' "$GROUP_BACKUP_FILE")

        VALID_MEMBERS=()
        for username in $BACKED_UP_MEMBERS; do
            if yunohost user info "$username" &>/dev/null; then
                VALID_MEMBERS+=("$username")
            else
                ynh_print_warn "User $username not found on system, skipping."
            fi
        done

        if [ ${#VALID_MEMBERS[@]} -gt 0 ]; then
            yunohost user group add "$syncyunohost_main_group" "${VALID_MEMBERS[@]}"
        else
            ynh_print_warn "No valid users found to restore for group $syncyunohost_main_group"
        fi
    fi
else
    ynh_print_warn "No group backup file found, skipping group restoration."
fi

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Restoration completed for $app"
